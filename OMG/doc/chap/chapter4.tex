\chapter{标注工具的软件模型设计}
\label{}
在这一章中我将结合软件设计中的UML图来说明整体软件的设计，从软件工程的角度说明软件的设计，构建部分、由于篇幅所限，我将仅仅提及在本软件设计中较为重要的几节，也即：需求分析，
用况图文档。同时通过软件的设计分析，我将简明概要地分析本软件的结构，以此来将整个软件的各个模块清晰地
介绍出来。
\section{需求分析及构建图文档}

本软件的整体系统主要由以下几个子部分构成：
\begin{figure}[ht]
      \centering
      \includegraphics[width=0.85\linewidth]{img/chapter4/subsystem.pdf}
      \caption{子系统划分构建图}\label{fig:subsystem}
\end{figure}
\begin{enumerate}
  \item 文件浏览部分：用于浏览平台文件系统上的文件和选择图片。这是整个系统的入口点。
  \item 用户标注部分：用于单帧图像的前景分割。这是用户交互最为复杂也最为频繁的地方。
  \item 立体图生成部分：人际交互最少而计算量需要最大的部分，将标注结果生成深度图并且完成深度图，视差图，双目立体图。
\end{enumerate}

图\ref{fig:subsystem}是对于子系统的划分，由图\ref{fig:subsystem}可以看出，我们与上文一致地将整个系统划分为了三个子系统。而每个子系统之间最多有两个接口关联。
这样在之后使用Android编写代码的时候可以以此为依据划分不同的子Acitivity。
需要说明的是由于参与者只有标注用户一个人，之后的分析默认为只有一个参与者。以下给出子系统的需求分析：
\subsection{文件浏览子系统}
文件浏览子系统是三个子系统中较为简单的一个部分，它的功能需求如下：
\begin{itemize}
  \item 浏览SD卡文件系统上的文件，需要能够遍历所有的具有用户权限的文件夹。由于我们标注的文件一概是图像文件，
  为了便于用户的选择和浏览，不应该列出不必要的文件如txt文件等。另一方面处于对系统安全性(这里指的是对于整个android系统的安全性)
  考虑，不应该让用户拥有浏览系统所在的文件夹的权限，并且实现返回根目录的功能。
  \item 当用户需要浏览一个文件夹的时候向用户呈现一个图片浏览器，并且让用户能够自由浏览图片。
  \item 当用户点击图片浏览器上的图片的时候需要将所选择的图片传递给图片标注程序。
\end{itemize}
据此分析的用况包括：更改当前文件夹，浏览图片，传递图片给用户标注部分。
\subsection{用户标注子系统}
用户标注子系统是三个子系统中交互最复杂的部分，它的功能需求如下：
\begin{itemize}
  \item 分出三个状态，分别为图片调整，前景物体分割，前景物体调整
  \item 在图片调整状态的时候允许用户移动图片，并且允许用户调整图片的大小。与此同时原有的图像标记也必须要同步。
  \item 在前景物体分割状态下，当用户点击屏幕的时候需要能够将屏幕上的坐标转换成实际的图片上的逻辑坐标。这个转换在图片放大和调整了位置之后依旧
      要有效。
  \item 用户点击了当前的两点之后，需要生成切割后的边缘，并且将边缘显示在屏幕上。
  \item 对于一个正在分割中的物体，仅仅开放边缘的两个端点供点击，别的部分则显示为灰色不能够点击，对于
  用户点击的端点在别的物体内的情况，不能响应以避免物体重叠。
  \item 当用户将边缘的两个端点相连时要跳出警告，当用户确认确实要封闭曲线之后完成一个前景物体的标注。而此时根据前景物体的深度
  给物体标上一层有透明度的颜色以便标明已经分割了的前景物体。
  \item 在前景物体调整的状态下，如果用户点击了一个前景物体弹出一个对话框供用户调整深度，删除当前物体用。
\end{itemize}
这里分析出来的用况比较多，根据子系统的三个状态可以大致分成三个用况：图片调整，前景物体分割，前景物体调整。
\subsection{立体图像生成子系统}
立体图像生成子系统是三个子系统中计算量最大的一个子系统，但是交互很少，它的功能需求如下：
\begin{itemize}
    \item 图像自动背景估计
  \item 将用户标注子系统生成的用户标注与自动背景估计相结合，生成整体的图像深度图
  \item 在预览时返回一个系统深度图
  \item 将深度图转换为视差图，最后转换为双目立体图
\end{itemize}
这里得到的用况包括：背景深度自动估计，最终图像深度图生成，最终立体图生成。


\section{用况分析及用况图文档}
图\ref{fig:usecase}是系统用况图
\begin{figure}[htbp]
      \centering
      \includegraphics[width=0.8\linewidth]{img/chapter4/usecase.pdf}
      \caption{用况分析图}\label{fig:usecase}
\end{figure}

实际上为了用况图结构的清晰，这里的用况图合并了一些小的用况。我们需要注意到的就是这里子系统的边界比较清晰，并且时间序较为明显。
以下是分系统对于用况的描述：
\subsection{文件浏览子系统}
\begin{itemize}
  \item[\ding{226}] 用况图综述：

  文件浏览子系统实现的是从标注工具开启的时刻，用户浏览文件系统并且查找所需图片的过程。在这个过程中需要保证系统文件和隐藏文件的
  不可见性以确保我们的程序对于操作系统是安全的。
  \item[\ding{226}] 参与者描述：

  只有一个参与者即标注用户。不过由于仅仅在这个工具的单独实现中是由用户来选择图片的，而当其加入到整个视频标注系统的时候单人的标注
  目标图像则是来自于主服务器的分配，所以实际上在处理的过程中我们将其当作是一个单独的参与者。

  相关用况：浏览文件，图像选择。
  \item[\ding{226}] 用况描述：
  \begin{itemize}
    \item[\ding{227}] 用况：浏览文件

    用户选择子文件夹：如果该子文件夹中有文件或者文件夹，则将当前文件夹切换到子文件夹，并且列出子文件夹和文件夹下的图片。否则提示空文件夹。

    用户选择文件以及选择浏览文件夹：切换到一个图片浏览器窗口，显示当前文件夹下所有图片。

    用户选择返回上一级文件夹：将当前文件夹切换为上一级目录，但是在/mnt/sdcard(即SD卡中用户所拥有权限的最顶层目录)时不响应操作，保证
    用户对系统目录的不可见。

    用户选择退出文件浏览器：退出图片浏览器，并且回到之前的文件夹列表。目录与之前一致。
    \item[\ding{227}] 用况：选择文件

    用户双击图像：将该图像传递给用户标注子系统。

    用户滑动浏览器：切换到下一张或者上一张图片。
  \end{itemize}
\end{itemize}

\subsection{前景标注子系统}
\begin{itemize}
  \item[\ding{226}] 用况图综述：

  前景标注子系统从用户获得了图片之后，将其全屏显示在屏幕上。之后通过前景图像分割得到前景，经过深度调整，轮廓调整等生成完整的前景用户
  标注。
  \item[\ding{226}] 参与者描述：

  这里的参与者在单机和系统集成的两种情况下都是标注用户。相关用况：图像调整显示，智能剪刀分割边缘，边缘调整，深度调整。
  \item[\ding{226}] 用况描述：
  \begin{itemize}
    \item[\ding{227}] 用况：图像显示调整

    用户点击放大缩小按钮：图像当前中心位置不变，图片整体放大或者缩小。同时调用图像显示重画接口。

    用户调整图片位置：如果当前处于图像调整状态，则更改图片的起始坐标，同时调用图像显示重画接口。
    \item[\ding{227}] 用况：前景物体分割

    [前置条件]:当前状态为前景分割

    用户依次点击两个端点的时候划分出一条由Intelligent Scissors获得的边缘曲线，并且将其增加到当前已有的边缘当中去。同时更新被激活的线段端点。最后调用图像显示重画接口
    更新屏幕上的内容。

    当用户将现有的两个激活状态的端点相连的时候，提示用户这个操作会导致曲线的闭合。当得到用户的确认的时候为这个标注中
    的前景加入最后一条边，并且将曲线闭合。之后生成新的前景分割。
    \item[\ding{227}] 用况：边缘调整

    [前置条件]:当前已有分割完成的前景物体并且选定了一个前景物体

    由于前景物体的边缘是由若干条边缘曲线首尾相连组成，而原有断线保留。调整时需要调节对应边缘曲线的端点的位置，并且重新
    调用调用Intelligent Scissors分割边缘，更新边缘曲线。
    \item[\ding{227}] 用况：深度调整

    [前置条件]:当前已有分割完成的前景物体并且选定了一个前景物体

    用户拖动SeekBar来在0~255范围内调整物体深度，并且根据该深度调整前景物体的深度，调用重画接口反映在屏幕上。
  \end{itemize}

\end{itemize}
\subsection{立体图像生成子系统}
\begin{itemize}
  \item [\ding{226}] 用况图综述：

  立体图像生成这个子系统较为特殊，它没有参与者。实际上它负责将用户的标注和自动的背景深度估计结合起来并且生成立体
  双目视频。这个子系统提供的接口主要被之前两个子系统调用。而且在之后集成到我们的整体标注系统后这部分应该由计算能力
  充裕的主服务器进行。
  \item [\ding{226}] 用况描述：
  \begin{itemize}
    \item [\ding{227}] 用况：浏览深度图

    [前置条件]：当前已经初始化完成

    一般这个用况由标注界面调用。而背景的深度图在初始化的时候应该已经生成。在每一次调用这个方法的时候都从前景标注
    子系统中获得用户的标注情况，之后同当前的深度图结合后生成该帧的深度图最后输出在屏幕上。
    \item [\ding{227}]用况：生成立体图

    [前置条件]：当前深度图已经完成

    生成立体图在用户保存输出文件的情况下完成，这时调用深度图转换视差图模块将生成的深度图转换成视差图。最后调用立体
    图像生成模块将视差图转换成双目立体图。
  \end{itemize}
\end{itemize}
\section{部分类图文档}
以下仅以OOD(问题域)部分类图文档中的前景标注子系统为例说明：
\begin{figure}[htbp]
  % Requires \usepackage{graphicx}
  \includegraphics[width=\textwidth]{img/chapter4/class.pdf}\\
  \caption{前景标注部分OOD类图}\label{fig:class}
\end{figure}

其中图\ref{fig:class}是前景标注子系统部分的类图文档。由于前景标注子系统是较为整个系统中较为复杂的部分，所以我们
以此作为例子说明我们的类图的设计，并且期望以此来清晰地传达出软件模型设计时的思路。以下是类图中出现的类的说明：

\begin{itemize}
  \item [\ding{226}]前景物体

  前景物体这个类定义了一个前景物体所具有的特征，例如边缘曲线以及组成边缘的所有曲线的顶点。并且定义最基本的前景物体
  将自己绘制在屏幕上的行为。
  \item [\ding{226}]前景物体标注完
  
  这个类继承自前景物体，用于定义一个已经分割完毕的前景物体。并且增加了前景物体的一些特征，例如深度和所占据的区域。
  \item [\ding{226}]临时标注物体
  
  这个类用于定义一个临时标注的物体，具有代表临时标注物体的一些信息，例如开放供点击扩展的端点。
  \item [\ding{226}]画板-数据通信接口
  
  定义了一个从画板的用户操作行为到数据的接口，主要是将用户的抽象行为转换为具体的动作序列。
  \item [\ding{226}]画板类
  
  画板类的响应了用户分割的时候主要的操作，并且根据操作的类别来调用各个不同的模块。
  \item [\ding{226}]LineAdaptor
  
  LineAdaptor是用于实现智能剪刀功能的类。这个类是JAVA虚拟机和本地库文件的接口。
\end{itemize}
\section{软件模型总结}
通过本章的分析，我们可以清楚地了解到整个软件的构架。另一方面通过对于软件子系统的划分，我们可以分析出在软件的运行周期中，软件的各个
部分对于资源的需求，以及它们互相之间调用的情况。通过这些信息就可以在下一步合理地分配计算资源以及使用合适的方式来实现我们事先定义好的
各种算法。

通过在这一章的分析我们可以明显地看到软件各个子系统之间的关系，以及各个子系统之间互相的消息传递。这样我们就可以
基于实现平台的特点和用户操作的需求来设计我们软件的界面。

另一方面，通过清晰地梳理出独立的大计算量的模块，让我们对于各个部分对于计算资源的要求层次有了比较清晰的认识。这样
就能够针对性地设计一些方法使得计算得到优化。 